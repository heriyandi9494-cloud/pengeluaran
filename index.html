
<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pengeluaran Harian - Login Email/Password</title>
<!-- Bootstrap 5 CSS -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { background-color:#040b14; color:#e50e0e; font-family: 'Roboto', sans-serif; }
.card { background: rgba(15,25,40,0.85); border:2px solid #0ff; }
.card-header { background:#00f6ff; color:#000; text-align:center; font-weight:bold; text-shadow:0 0 5px #fff; }
.table thead { background:#00ecff; color:rgb(248, 241, 241); }
.table td.masuk { background: #00ffa6; }
.table td.keluar { background: #ff00ff; }
.summary { margin-top:15px; padding:12px; background:#fff; border:1px solid #0ff; border-radius:10px; }
.modal-header { background:#00f6ff; color:#000; }
.modal-content { background:#0f1928; color:#fff; border:2px solid #0ff; }
.btn-add { background:#00ffa6; color:#000; }
.btn-add:hover { background:#00ffa6; opacity:0.8; }
.btn-refresh { background:#00c3ff; color:#000; }
.btn-refresh:hover { background:#00c3ff; opacity:0.8; }
.btn-del { background:#ff3b3b; color:#fff; }
.btn-del:hover { background:#ff3b3b; opacity:0.8; }
</style>
</head>
<body>

<div class="container my-4">
  <div class="card p-3">
    <div class="card-header fs-4">CATATAN PENGELUARAN</div>

    <div class="d-flex flex-wrap gap-2 my-3">
      <input type="date" id="filterDate" class="form-control form-control-sm w-auto">
      <button class="btn btn-refresh btn-sm" id="btnFilter">Filter</button>
      <button class="btn btn-refresh btn-sm" id="btnClearFilter" style="background:#ff00ff;">Reset</button>
      <button class="btn btn-add btn-sm" id="btnLogin">Login</button>
    </div>

    <div class="table-responsive">
      <table class="table table-bordered table-hover text-center" id="dataTable">
        <thead>
          <tr>
            <th>NO</th>
            <th>TANGGAL</th>
            <th>KETERANGAN</th>
            <th>JENIS</th>
            <th>TOTAL</th>
            <th>AKSI</th>
            <th>SISA SALDO</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="my-2">
      <button class="btn btn-add" id="btnTambah">+ Tambah Data</button>
    </div>

    <div class="summary d-flex flex-wrap gap-3 justify-content-between">
      <div>Total Uang Masuk: <b id="uangMasuk">0</b></div>
      <div>Total Uang Keluar: <b id="uangKeluar">0</b></div>
      <div>Sisa Saldo: <b id="saldo">0</b></div>
    </div>
  </div>
</div>

<!-- Modal Tambah Data -->
<div class="modal fade" id="modalForm" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content p-3">
      <div class="modal-header">
        <h5 class="modal-title">Tambah Pengeluaran / Pemasukan</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="text" id="inpKeterangan" class="form-control mb-2" placeholder="Keterangan">
        <select id="inpJenis" class="form-select mb-2">
          <option value="">--Pilih Jenis--</option>
          <option value="masuk">Masuk</option>
          <option value="keluar">Keluar</option>
        </select>
        <input type="number" id="inpTotal" class="form-control mb-2" placeholder="Total (Rp)">
        <input type="date" id="inpTanggal" class="form-control mb-2">
      </div>
      <div class="modal-footer">
        <button class="btn btn-add" id="saveBtn">Simpan</button>
        <button class="btn btn-refresh" data-bs-dismiss="modal">Batal</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Login -->
<div class="modal fade" id="modalLogin" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content p-3">
      <div class="modal-header">
        <h5 class="modal-title">Login</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="email" id="loginEmail" class="form-control mb-2" placeholder="Email">
        <input type="password" id="loginPass" class="form-control mb-2" placeholder="Password">
      </div>
      <div class="modal-footer">
        <button class="btn btn-add" id="loginBtn">Login</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script type="module">
// ==== Script JS Anda tetap sama, hanya perlu menyesuaikan modal dengan Bootstrap ====
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
import { getDatabase, ref, push, onValue, remove } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-database.js";
import { getAuth, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCynyU77o-qLZgr9ce-4baOgd9R5k4UJVs",
  authDomain: "pengeluaran-harian-bfcac.firebaseapp.com",
  projectId: "pengeluaran-harian-bfcac",
  storageBucket: "pengeluaran-harian-bfcac.firebasestorage.app",
  messagingSenderId: "208832412926",
  appId: "1:208832412926:web:ca920a7001fe3e9d83f9af",
  measurementId: "G-5CRSKPTC50"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);
let UID = null;
let allData = [];

function formatRupiah(x){ return Number(x||0).toLocaleString('id-ID'); }
function escape(t){ return String(t||''); }

// Modal Bootstrap
const modalForm = new bootstrap.Modal(document.getElementById('modalForm'));
const modalLogin = new bootstrap.Modal(document.getElementById('modalLogin'));

// Login
document.getElementById("btnLogin").addEventListener("click", ()=>{ modalLogin.show(); });
document.getElementById("loginBtn").addEventListener("click", ()=>{
  const email = document.getElementById("loginEmail").value.trim();
  const password = document.getElementById("loginPass").value.trim();
  if(!email||!password)return alert("Masukkan email & password!");
  signInWithEmailAndPassword(auth,email,password)
    .then(userCredential=>{ UID=userCredential.user.uid; modalLogin.hide(); loadData(); })
    .catch(err=>alert("Login gagal: "+err.message));
});

// Auth State
onAuthStateChanged(auth,user=>{ if(user){ UID=user.uid; loadData(); }});

// Load Data
function loadData(){
  if(!UID) return;
  onValue(ref(db, `pengeluaran/${UID}`), snap=>{
    const d=snap.val()||{};
    allData=Object.keys(d).map(id=>({id,...d[id]}));
    renderTable(allData);
  });
}

// Render Table
function renderTable(data){
  const tbody=document.querySelector("#dataTable tbody");
  tbody.innerHTML="";
  let masuk=0, keluar=0, saldo=0, no=1;
  data.sort((a,b)=>a.tanggal.localeCompare(b.tanggal)).forEach(r=>{
    const nilai = Number(r.total);
    if(r.jenis==="masuk") saldo+=nilai; else saldo-=nilai;
    masuk += r.jenis==="masuk"?nilai:0;
    keluar += r.jenis==="keluar"?nilai:0;

    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${no++}</td>
      <td>${escape(r.tanggal)}</td>
      <td>${escape(r.keterangan)}</td>
      <td class="${r.jenis}">${escape(r.jenis)}</td>
      <td class="${r.jenis}" style="text-align:right">${formatRupiah(r.total)}</td>
      <td><button class="btn btn-del btn-sm" data-id="${r.id}">Hapus</button></td>
      <td style="text-align:right"><b>${formatRupiah(saldo)}</b></td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById("uangMasuk").innerText=formatRupiah(masuk);
  document.getElementById("uangKeluar").innerText=formatRupiah(keluar);
  document.getElementById("saldo").innerText=formatRupiah(masuk-keluar);

  document.querySelectorAll(".btn-del").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      if(confirm("Yakin hapus data?")){
        remove(ref(db, `pengeluaran/${UID}/${btn.dataset.id}`));
      }
    });
  });
}

// Tambah Data
document.getElementById("btnTambah").addEventListener("click", ()=>{
  if(!UID) return alert("Login dulu!");
  document.getElementById("inpKeterangan").value="";
  document.getElementById("inpJenis").value="";
  document.getElementById("inpTotal").value="";
  document.getElementById("inpTanggal").value = new Date().toISOString().substring(0,10);
  modalForm.show();
});
document.getElementById("saveBtn").addEventListener("click", ()=>{
  if(!UID) return alert("Login dulu!");
  const k=document.getElementById("inpKeterangan").value.trim();
  const j=document.getElementById("inpJenis").value;
  const t=Number(document.getElementById("inpTotal").value);
  const tg=document.getElementById("inpTanggal").value;
  if(!k||!j||!t||!tg) return alert("Data tidak lengkap!");
  push(ref(db, `pengeluaran/${UID}`), { keterangan:k, jenis:j, total:t, tanggal:tg });
  modalForm.hide();
});

// Filter
document.getElementById("btnFilter").addEventListener("click", ()=>{
  const f=document.getElementById("filterDate").value;
  renderTable(allData.filter(x=>x.tanggal===f));
});
document.getElementById("btnClearFilter").addEventListener("click", ()=>{
  document.getElementById("filterDate").value="";
  renderTable(allData);
});
</script>
</body>
</html>
